@model IEnumerable<EcommerceStore.Models.Category>

@{
    ViewData["Title"] = "Groceries";
    var activeCategories = Model.Where(c => c.Products.Any()).ToList();
}

<div class="container-fluid px-0 py-4">

    <div class="category-nav-container shadow-sm p-2">
        <div class="container-fluid px-0">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md-5 col-lg-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text border-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="productSearch" class="form-control border-0" placeholder="Search products...">
                    </div>
                </div>
                <div class="col-12 col-md-7 col-lg-8">
                    <div class="dropdown" id="categoryDropdownContainer">
                        <button class="btn btn-sm btn-outline-light dropdown-toggle w-100 d-flex justify-content-between align-items-center border-0 bg-white-10 text-start px-3 py-2" 
                                type="button" id="categoryDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <span><i class="bi bi-list-task me-2"></i>Select Category</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 w-100" aria-labelledby="categoryDropdownButton" style="max-height: 400px; overflow-y: auto;">
                            @foreach (var category in activeCategories)
                            {
                                <li>
                                    <a class="dropdown-item category-select-link py-2 d-flex justify-content-between align-items-center" 
                                       href="#category-@category.Id" data-category="@category.Name">
                                        @category.Name
                                        <span class="badge rounded-pill bg-light text-dark border ms-2">@category.Products.Count()</span>
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion accordion-flush pt-2" id="categoryAccordion">
        @{
            for (int i = 0; i < activeCategories.Count; i++)
            {
                var category = activeCategories[i];
                <div class="accordion-item border-0 mb-3 shadow-sm rounded-4 overflow-hidden" id="category-@category.Id">
                    <h2 class="accordion-header" id="heading-@category.Id">
                        <button class="accordion-button fw-bold py-3 fs-5" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse-@category.Id" 
                                aria-expanded="true" 
                                aria-controls="collapse-@category.Id">
                            <i class="bi bi-tag-fill me-2 text-primary"></i>
                            @category.Name 
                            <span class="badge bg-secondary-subtle text-secondary ms-2 rounded-pill fs-7">@category.Products.Count() items</span>
                        </button>
                    </h2>
                    <div id="collapse-@category.Id" 
                         class="accordion-collapse collapse show" 
                         aria-labelledby="heading-@category.Id">
                        <div class="accordion-body bg-light-subtle pt-4">
                            <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
                                @foreach (var product in category.Products)
                                {
                                    <div class="col">
                                        <div class="card h-100 shadow-sm border-0 product-card">
                                            @if (!string.IsNullOrEmpty(product.ImageFileName))
                                            {
                                                <img src="~/images/@product.ImageFileName" class="card-img-top" alt="@product.Name" style="height: 180px; object-fit: cover;">
                                            }
                                            else
                                            {
                                                <div class="bg-light text-center py-5" style="height: 180px;">
                                                    <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                                </div>
                                            }
                                            <div class="card-body">
                                                <h5 class="card-title fw-bold mb-1">@product.Name</h5>
                                                <p class="card-text opacity-75 small mb-3 text-truncate-2">@product.Description</p>
                                                <div class="d-flex justify-content-between align-items-center mt-auto">
                                                    <span class="h5 mb-0 text-success fw-bold">$@product.Price.ToString("F2")</span>
                                                    <div class="input-group input-group-sm" style="width: 110px;">
                                                        <button class="btn btn-outline-secondary btn-minus" type="button" data-id="@product.Id" data-price="@product.Price">-</button>
                                                        <input type="text" class="form-control text-center qty-input" value="0" readonly data-id="@product.Id" autocomplete="off">
                                                        <button class="btn btn-outline-secondary btn-plus" type="button" data-id="@product.Id" data-price="@product.Price">+</button>
                                                    </div>
                                                </div>
                                                <div class="mt-2 text-end opacity-75 small">
                                                    Total: <span class="fw-bold product-total" data-id="@product.Id">$0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <div class="card shadow-lg mt-5 border-0 theme-aware-footer p-4 sticky-bottom" id="order-summary-footer" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">Your Order Total: <span id="grand-total" style="color:white">$0.00</span></h4>
            </div>
            <button type="button" class="btn btn-light btn-lg px-5 fw-bold" data-bs-toggle="modal" data-bs-target="#checkoutModal" id="checkout-btn-main">Checkout Now</button>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Complete Your Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-controller="Orders" asp-action="Checkout" method="post" id="checkout-form">
                <div class="modal-body">
                    <div class="alert alert-success">You can pay cash or zelle to Pinki Basra 980.370.1091</div>
                    <p class="opacity-75">Enter your details to receive your unique Order ID.</p>
                    <div class="mb-3">
                        <label for="CustomerEmail" class="form-label">Email Address</label>
                        <input type="email" name="CustomerEmail" id="CustomerEmail" class="form-control" required placeholder="name@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="PhoneNumber" class="form-label">Phone Number (US Format)</label>
                        <input type="tel" name="PhoneNumber" id="PhoneNumber" class="form-control" required 
                               placeholder="(555) 555-5555" 
                               pattern="^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$"
                               title="Please enter a valid US phone number (e.g. (555) 555-5555 or 555-555-5555)">
                    </div>
                    <div class="mb-3">
                        <label for="DeliveryAddress" class="form-label">Delivery Address</label>
                        <input type="text" name="DeliveryAddress" id="DeliveryAddress" class="form-control" required placeholder="Start typing your address...">
                    </div>
                    <div id="cart-data-container"></div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-link text-muted" data-bs-dismiss="modal">Keep Shopping</button>
                    <button type="submit" class="btn btn-primary px-4">Place Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize Google Autocomplete
            if (typeof google !== 'undefined') {
                const input = document.getElementById("DeliveryAddress");
                if (input) {
                    const autocomplete = new google.maps.places.Autocomplete(input);
                    autocomplete.setFields(["address_components", "formatted_address"]);
                }
            }

            function syncDisplay() {
                const cart = CartManager.getCart();
                
                // Reset all inputs first
                $('.qty-input').val(0);
                $('.product-total').text('$0.00');

                let grandTotal = 0;
                let itemCount = 0;

                for (let id in cart) {
                    const item = cart[id];
                    $(`.qty-input[data-id="${id}"]`).val(item.qty);
                    $(`.product-total[data-id="${id}"]`).text('$' + (item.qty * item.price).toFixed(2));
                    grandTotal += item.qty * item.price;
                    itemCount += item.qty;
                }

                $('#grand-total').text('$' + grandTotal.toFixed(2));
                if (itemCount > 0) {
                    $('#order-summary-footer').fadeIn();
                } else {
                    $('#order-summary-footer').fadeOut();
                }
            }

            // Sync on load and on page show (handles browser back button)
            syncDisplay();
            window.addEventListener('pageshow', function(event) {
                syncDisplay();
            });

            // Handle cart updates from site.js
            $(document).on('cartUpdated', function() {
                syncDisplay();
            });

            $('.btn-plus').click(function () {
                const card = $(this).closest('.product-card');
                const accordionItem = $(this).closest('.accordion-item');
                const product = {
                    id: $(this).data('id'),
                    name: card.find('.card-title').text(),
                    category: accordionItem.find('.accordion-button').contents().filter(function() {
                        return this.nodeType === 3; // Get only text nodes
                    }).text().trim(),
                    price: parseFloat($(this).data('price'))
                };
                CartManager.addItem(product);
            });

            $('.btn-minus').click(function () {
                const id = $(this).data('id');
                CartManager.removeItem(id);
            });

            $('#checkout-form').submit(function (e) {
                const cart = CartManager.getCart();
                let container = $('#cart-data-container');
                container.empty();
                let index = 0;
                for (let id in cart) {
                    container.append(`<input type="hidden" name="Items[${index}].ProductId" value="${id}" />`);
                    container.append(`<input type="hidden" name="Items[${index}].Quantity" value="${cart[id].qty}" />`);
                    index++;
                }
            });

            // Phone number auto-formatting (US: (XXX) XXX-XXXX)
            $('#PhoneNumber').on('input', function (e) {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            });

            // Active category highlighting on scroll + update dropdown text
            $(window).scroll(function() {
                var scrollDistance = $(window).scrollTop() + 150;
                var found = false;

                $('.accordion-item:visible').each(function(i) {
                    if ($(this).position().top <= scrollDistance) {
                        var categoryName = $(this).find('.accordion-button').contents().filter(function() {
                            return this.nodeType === 3;
                        }).text().trim();
                        
                        $('#categoryDropdownButton span').html('<i class="bi bi-list-task me-2"></i>' + categoryName);
                        
                        $('.category-select-link.active').removeClass('active');
                        $('.category-select-link').eq(i).addClass('active');
                        found = true;
                    }
                });

                if (!found && $('.accordion-item:visible').length > 0) {
                     $('#categoryDropdownButton span').html('<i class="bi bi-list-task me-2"></i>Select Category');
                }
            }).scroll();

            // Smooth scroll adjustment for category links
            $('.category-select-link').click(function(e) {
                e.preventDefault();
                var target = $(this).attr('href');
                $('html, body').animate({
                    scrollTop: $(target).offset().top - 110
                }, 100);
            });

            // Product Filtering Logic
            $('#productSearch').on('input', function() {
                var query = $(this).val().toLowerCase().trim();
                
                $('.accordion-item').each(function() {
                    var $accordion = $(this);
                    var hasVisibleProducts = false;

                    $accordion.find('.col').each(function() {
                        var $productCol = $(this);
                        var productName = $productCol.find('.card-title').text().toLowerCase();
                        var productDesc = $productCol.find('.card-text').text().toLowerCase();

                        if (productName.includes(query) || productDesc.includes(query)) {
                            $productCol.show();
                            hasVisibleProducts = true;
                        } else {
                            $productCol.hide();
                        }
                    });

                    if (hasVisibleProducts) {
                        $accordion.show();
                    } else {
                        $accordion.hide();
                    }
                });

                // Update dropdown visibility
                $('.category-select-link').each(function() {
                    var targetId = $(this).attr('href');
                    if ($(targetId).is(':visible')) {
                        $(this).closest('li').show();
                    } else {
                        $(this).closest('li').hide();
                    }
                });

                // Reset dropdown text if no categories match
                if ($('.category-select-link:visible').length === 0) {
                     $('#categoryDropdownButton span').text('No matches found');
                } else {
                    $(window).scroll(); // Trigger scroll to update active text
                }
            });
        });
    </script>
}

<style>
    .product-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 12px;
        overflow: hidden;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .accordion-button:not(.collapsed) {
        background-color: rgba(128, 128, 128, 0.05) !important;
        color: var(--text-color) !important;
    }
    .accordion-button:not(.collapsed) .bi {
        color: var(--primary-color) !important;
    }
    .accordion-button:not(.collapsed) .badge {
        background-color: rgba(128, 128, 128, 0.1) !important;
        color: var(--text-color) !important;
    }
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,0.1);
    }
    #order-summary-footer {
        z-index: 1000;
        bottom: 20px;
        left: 20px;
        right: 20px;
        width: auto;
        border-radius: 15px;
        background-color: var(--nav-bg);
        backdrop-filter: blur(15px);
        color: var(--nav-text);
        border: 1px solid rgba(128,128,128,0.2) !important;
    }

    #checkout-btn-main {
        background-color: var(--nav-text);
        color: var(--nav-bg);
        border: none;
    }

    .pac-container {
        z-index: 9999 !important;
    }


    .category-nav-container {
        position: sticky;
        top: 56px; /* Adjust based on navbar height */
        z-index: 1020;
        background-color: var(--bg-color);
        margin-top: -1.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid rgba(128, 128, 128, 0.3) !important;
    }

    .bg-white-10 {
        background-color: var(--bs-tertiary-bg) !important;
    }

    #categoryDropdownButton {
        color: var(--text-color) !important;
        border: 1px solid rgba(128, 128, 128, 0.2) !important;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    #categoryDropdownButton:hover, #categoryDropdownButton:focus {
        background-color: rgba(128, 128, 128, 0.1) !important;
        border-color: var(--primary-color) !important;
    }

    #categoryDropdownButton::after {
        margin-left: 0.5rem;
    }

    .dropdown-menu {
        border-radius: 12px;
        padding: 0.5rem;
        background-color: var(--card-bg);
    }

    .category-select-link {
        border-radius: 8px;
        color: var(--text-color);
        font-weight: 500;
        transition: background 0.2s;
    }

    .category-select-link:hover {
        background-color: rgba(128, 128, 128, 0.1);
        color: var(--primary-color);
    }

    .category-select-link.active {
        background-color: var(--primary-color) !important;
        color: #fff !important;
    }

    .category-select-link.active .badge {
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: #fff !important;
        border: none !important;
    }

    #productSearch {
        border-radius: 50px;
        padding-left: 0.75rem;
        background-color: var(--bs-tertiary-bg) !important;
        color: var(--text-color) !important;
    }

    #productSearch::placeholder {
        color: var(--text-color);
        opacity: 0.5;
    }

    .category-nav-container .input-group-text {
        border-radius: 50px 0 0 50px;
        padding-left: 15px;
        background-color: var(--bs-tertiary-bg) !important;
        color: var(--text-color) !important;
        opacity: 0.7;
    }

    /* Target the search icon specifically to ensure it's easy on the eyes */
    .category-nav-container .bi-search {
        color: var(--text-color) !important;
        opacity: 0.4 !important;
    }

    /* Refine nav border for dark mode */
    [data-bs-theme="dark"] .category-nav-container {
        border-bottom-color: rgba(255, 255, 255, 0.1) !important;
    }

    .category-scroll-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Hide scrollbar Firefox */
    }

    .category-scroll-wrapper::-webkit-scrollbar {
        display: none; /* Hide scrollbar Chrome/Safari */
    }

    .category-nav-link {
        color: var(--nav-link);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
        border: 1px solid transparent;
        background-color: rgba(255, 255, 255, 0.1);
    }

    .category-nav-link:hover {
        color: var(--nav-link-hover);
        background-color: rgba(255, 255, 255, 0.2);
    }

    .category-nav-link.active {
        background-color: var(--nav-text);
        color: var(--nav-bg) !important;
    }

    /* Highlight badge in active link */
    .category-nav-link.active .badge {
        background-color: var(--nav-bg) !important;
        color: var(--nav-text) !important;
    }

    /* Scroll offset for fixed headers */
    .accordion-item {
        scroll-margin-top: 120px; /* main navbar + category nav + padding */
    }

    html {
        scroll-behavior: smooth;
    }
</style>
